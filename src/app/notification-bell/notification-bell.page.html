<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Notifications</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="markAllAsRead()" [disabled]="unreadCount === 0 || loading">
        <ion-icon slot="start" name="checkmark-done-outline"></ion-icon>
        Tout marquer comme lu
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="notifications-container">
    <!-- En-tête -->
    <ion-card *ngIf="unreadCount > 0" color="primary">
      <ion-card-content class="unread-header">
        <ion-icon name="notifications" class="header-icon"></ion-icon>
        <div class="header-text">
          <h3>Vous avez {{ unreadCount }} notification(s) non lue(s)</h3>
          <p>Cliquez sur "Tout marquer comme lu" pour les effacer</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Liste des notifications -->
    <div *ngIf="!loading; else loadingTemplate">
      <ion-list *ngIf="notifications.length > 0; else emptyTemplate">
        <ion-item *ngFor="let notification of notifications" [class.unread]="!notification.estVu"
          (click)="handleNotificationClick(notification)" class="notification-item" button detail="false">

          <ion-icon slot="start" [name]="getNotificationIcon(notification.type)"
            [color]="getNotificationColor(notification.type)" class="notification-icon">
          </ion-icon>

          <ion-label class="notification-content">
            <h2>{{ notification.titre }}</h2>
            <p>{{ notification.message }}</p>
            <p class="notification-time">
              {{ notification.createdAt | date:'dd/MM/yyyy à HH:mm' }}
            </p>
          </ion-label>

          <div slot="end" class="notification-actions">
            <ion-badge *ngIf="!notification.estVu" color="primary" class="unread-indicator">
              Nouveau
            </ion-badge>
            <ion-button fill="clear" size="small" (click)="markAsRead(notification); $event.stopPropagation()"
              [disabled]="notification.estVu">
              <ion-icon name="checkmark-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>

      <!-- Chargement infini -->
      <ion-infinite-scroll (ionInfinite)="loadMore($event)">
        <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Chargement de plus de notifications...">
        </ion-infinite-scroll-content>
      </ion-infinite-scroll>
    </div>

    <!-- États -->
    <ng-template #emptyTemplate>
      <div class="empty-state">
        <ion-icon name="notifications-off-outline" class="empty-icon"></ion-icon>
        <h3>Aucune notification</h3>
        <p>Vous serez notifié lorsque de nouvelles activités se produiront</p>
      </div>
    </ng-template>

    <ng-template #loadingTemplate>
      <div class="loading-state">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Chargement des notifications...</p>
      </div>
    </ng-template>
  </div>
</ion-content>